local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local arrestEnabled = false
local arrestRange = 10
local heartbeatConnection = nil

local function findArrestRemote()
	local remotesFolder = ReplicatedStorage:FindFirstChild("Remotes")
	if not remotesFolder then return end
	return remotesFolder:FindFirstChild("ArrestPlayer")
end

local function startArrestLoop()
	if heartbeatConnection then heartbeatConnection:Disconnect() end

	heartbeatConnection = RunService.Heartbeat:Connect(function()
		if not arrestEnabled then return end

		local character = LocalPlayer.Character
		if not character then return end

		local rootPart = character:FindFirstChild("HumanoidRootPart")
		if not rootPart then return end

		local arrestRemote = findArrestRemote()
		if not arrestRemote then return end

		for _, targetPlayer in ipairs(Players:GetPlayers()) do
			if targetPlayer == LocalPlayer then continue end

			local targetChar = targetPlayer.Character
			if not targetChar then continue end

			local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
			local targetHum = targetChar:FindFirstChild("Humanoid")
			if not targetRoot or not targetHum or targetHum.Health <= 0 then continue end

			local distance = (rootPart.Position - targetRoot.Position).Magnitude
			if distance <= arrestRange then
				task.spawn(function()
					pcall(function()
						arrestRemote:InvokeServer(targetPlayer)
					end)
				end)
			end
		end
	end)
end

local function stopArrestLoop()
	if heartbeatConnection then
		heartbeatConnection:Disconnect()
		heartbeatConnection = nil
	end
end

-- Grab the UI tab that the main script exposed
local weaponsTab = getgenv().FunnyHub_WeaponsTab
if not weaponsTab then return end

weaponsTab:Toggle({
	Title = "Arrest Aura",
	Description = "Automatically arrest any nearby players",
	Default = false,
	Callback = function(enabled)
		arrestEnabled = enabled
		if enabled then
			startArrestLoop()
		else
			stopArrestLoop()
		end
	end
})

weaponsTab:Slider({
	Title = "Arrest Range",
	Description = "Maximum distance to arrest (1â€‘10 studs)",
	Value = { Min = 1, Max = 10, Default = 10 },
	Step = 0.5,
	Callback = function(value)
		arrestRange = value
	end
})
