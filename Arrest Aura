local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer, "LocalPlayer"
local arrestEnabled = false
local arrestRange = 10
local heartbeatConn = nil

local function getArrestRemote()
	local remotes = ReplicatedStorage:FindFirstChild("Remotes")
	if not remotes then return end
	return remotes:FindFirstChild("ArrestPlayer")
end

local function startLoop()
	if heartbeatConn then heartbeatConn:Disconnect() end

	heartbeatConn = RunService.Heartbeat:Connect(function()
		if not arrestEnabled then return end

		local char = LocalPlayer.Character
		if not char then return end

		local root = char:FindFirstChild("HumanoidRootPart")
		if not root then return end

		local remote = getArrestRemote()
		if not remote then return end

		for _, target in Players:GetPlayers() do
			if target == LocalPlayer then continue end

			local tChar = target.Character
			if not tChar then continue end

			local tRoot = tChar:FindFirstChild("HumanoidRootPart")
			local tHum = tChar:FindFirstChild("Humanoid")
			if not tRoot or not tHum or tHum.Health <= 0 then continue end

			local dist = (root.Position - tRoot.Position).Magnitude
			if dist <= arrestRange then
				task.spawn(function()
					pcall(function()
						remote:InvokeServer(target)
					end)
				end)
			end
		end
	end)
end

local function stopLoop()
	if heartbeatConn then
		heartbeatConn:Disconnect()
		heartbeatConn = nil
	end
end

local weaponsTab = getgenv().FunnyHub_WeaponsTab
if not weaponsTab then return end

weaponsTab:Toggle({
	Title = "Arrest Aura",
	Description = "Automatically arrest any nearby player",
	Default = false,
	Callback = function(state)
		arrestEnabled = state
		if state then startLoop() else stopLoop() end
	end
})

weaponsTab:Slider({
	Title = "Arrest Range",
	Description = "Maximum distance (1-10 studs)",
	Value = { Min = 1, Max = 10, Default = 10 },
	Step = 0.5,
	Callback = function(value)
		local num = tonumber(value)
		if num and num >= 1 and num <= 10 then
			arrestRange = num
		else
			arrestRange = 10
		end
	end
})
