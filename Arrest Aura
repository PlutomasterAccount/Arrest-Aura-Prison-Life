local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local arrestEnabled = false
local arrestRange = 10
local heartbeatConn = nil

local function getArrestRemote()
	local folder = ReplicatedStorage:FindFirstChild("Remotes")
	if not folder then return end
	return folder:FindFirstChild("ArrestPlayer")
end

local function startLoop()
	if heartbeatConn then heartbeatConn:Disconnect() end

	heartbeatConn = RunService.Heartbeat:Connect(function()
		if not arrestEnabled then return end

		local char = LocalPlayer.Character
		if not char then return end

		local root = char:FindFirstChild("HumanoidRootPart")
		if not root then return end

		local remote = getArrestRemote()
		if not remote then return end

		for _, p in Players:GetPlayers() do
			if p == LocalPlayer then continue end

			local tChar = p.Character
			if not tChar then continue end

			local tRoot = tChar:FindFirstChild("HumanoidRootPart")
			local tHum = tChar:FindFirstChild("Humanoid")
			if not tRoot or not tHum or tHum.Health <= 0 then continue end

			if (root.Position - tRoot.Position).Magnitude <= arrestRange then
				task.spawn(function()
					pcall(function()
						remote:InvokeServer(p)
					end)
				end)
			end
		end
	end)
end

local function stopLoop()
	if heartbeatConn then
		heartbeatConn:Disconnect()
		heartbeatConn = nil
	end
end

local weaponsTab = getgenv().FunnyHub_WeaponsTab
if not weaponsTab then return end

weaponsTab:Toggle({
	Title = "Arrest Aura",
	Description = "Auto-arrest any nearby player",
	Default = false,
	Callback = function(v)
		arrestEnabled = v
		if v then startLoop() else stopLoop() end
	end
})

weaponsTab:Slider({
	Title = "Arrest Range",
	Description = "Max distance (1-10 studs)",
	Value = { Min = 1, Max = 10, Default = 10 },
	Step = 0.5,
	Callback = function(v)
		local n = tonumber(v)
		arrestRange = (n and n >= 1 and n <= 10) and n or 10
	end
})
